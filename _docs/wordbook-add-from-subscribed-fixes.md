# 구독 단어장 → 내 단어장 추가 안정화 정리

## 문서 목적

구독된(공유) 단어장의 단어를 내 단어장에 추가할 때 발생할 수 있는 데이터 정합성/권한 문제를 정리하고, 적용한 수정 사항을 기록한다.

## 문제 요약

- `user_word_state` 조회가 `word_id`만 기준이라 사용자 범위를 타지 않아 오동작 가능성이 있었다.
- 구독 단어를 내 단어장에 "참조(word_id 재사용)"로만 추가하면, 구독 해지 후 단어 접근이 깨질 수 있었다.

## 영향 범위

- Supabase 저장소 구현의 `wordbooks.addWord()` 경로
- 파일: `src/lib/repository/supabase-repo.ts`

## 적용한 수정

### 1) 대상 단어장 소유권 사전 검증

- 현재 로그인 사용자가 대상 단어장(`wordbookId`) 소유자인지 먼저 확인한다.
- 소유자가 아니면 즉시 에러를 발생시켜 잘못된 추가 시도를 차단한다.

### 2) 구독 단어 추가 시 "내 소유 단어"로 정규화

- 추가하려는 원본 단어가 내 소유(`words.user_id === auth.uid()`)가 아니면:
  - 먼저 내 `words`에서 `(term, reading)` 동일 단어를 찾는다.
  - 있으면 그 단어 ID를 재사용한다.
  - 없으면 원본 내용을 복제해서 내 `words`에 새로 생성한다.
- 이후 `wordbook_items`에는 항상 "내 소유 단어 ID"를 넣는다.

## 3) `user_word_state` 강제 보정 및 사용자 범위 mastered 체크

- 최종 단어 ID에 대해 `(user_id, word_id)` 기준으로 `user_word_state`를 upsert 한다.
- mastered 여부 확인도 반드시 `(user_id, word_id)`로 조회한다.
- mastered=true면 기존 규칙대로 추가를 차단한다.

## 변경 후 기대 동작

- 구독 단어를 내 단어장에 추가해도, 구독 해지 후 내 단어장에서 단어가 사라지지 않는다.
- mastered 판정이 "내 상태" 기준으로만 동작한다.
- 중복 추가는 기존과 동일하게 `wordbook_items` unique 제약으로 무시된다.

## 수동 검증 시나리오

1. 공유 단어장을 구독한다.
2. 구독 단어를 내 단어장에 추가한다.
3. 구독을 해지한다.
4. 내 단어장에서 해당 단어가 계속 보이는지 확인한다.
5. 해당 단어 mastered 처리 후 다시 추가 시 차단되는지 확인한다.

## 비고

- 이번 변경은 DB 스키마를 추가하지 않는다. 애플리케이션 레이어에서 안전하게 정규화한다.
- 용어 기준:
  - "구독 단어장": `wordbook_subscriptions` 기반으로 접근하는 공유 단어장
  - "내 단어장": `wordbooks.user_id = auth.uid()`인 단어장
